<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ì‰ì–´ìŠ¤íŒŸ - íŒë§¤/ëŒ€ì—¬ ë‚´ì—­</title>
    <link rel="stylesheet" href="../Css/style.css" />
    <link rel="stylesheet" href="../Css/history.css" />
    <style>
      /* íƒ­ ì „í™˜ì„ ìœ„í•œ ê°„ë‹¨í•œ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="brand">
        <img src="../Images/logo.png" alt="ë¡œê³ " class="brand-logo" />
        <div class="brand-text">
          <h1>ì‰ì–´ìŠ¤íŒŸ</h1>
          <p>ì‹œí¥ì‹œ ì •ì™•ë™</p>
        </div>
      </div>
      <div class="menu">
        <a href="main.html" class="menu-item"
          ><span class="menu-icon">ğŸ </span> í™ˆ</a
        >
        <a href="chat.html" class="menu-item"
          ><span class="menu-icon">ğŸ’¬</span> ì±„íŒ…<span class="badge" id="chatBadge" style="display:none;"></span>
        <a href="my.html" class="menu-item active"
          ><span class="menu-icon">ğŸ‘¤</span> ë‚˜ì˜ ì‹œí¥</a
        >
      </div>
      <a href="#" class="login" id="logoutBtn"> <span>ğŸ“•</span> ë¡œê·¸ì•„ì›ƒ </a>
    </div>

    <div class="main-content history-layout">
      <div class="edit-header">
        <button class="cancel-btn" onclick="history.back()">ë‚˜ê°€ê¸°</button>
        <div class="header-title">íŒë§¤/ëŒ€ì—¬ ë‚´ì—­</div>
        <div style="width: 48px"></div>
      </div>

      <div class="tabs">
        <div class="tab-item active" id="tabSelling" onclick="switchTab('selling')">
          íŒë§¤ì¤‘ (<span id="sellingCount">0</span>)
        </div>
        <div class="tab-item" id="tabSold" onclick="switchTab('sold')">
          ê±°ë˜ì™„ë£Œ (<span id="soldCount">0</span>)
        </div>
      </div>

      <div class="history-list" id="selling-list"></div>
      <div class="history-list hidden" id="sold-list"></div>

    <div id="logoutModalContainer"></div>

    <script src="../JS/auth.js"></script>
    <script>
      Auth.guard();
    </script>
    <script>
      // íƒ­ ì „í™˜ ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸
      function switchTab(tabName) {
        const sellingList = document.getElementById('selling-list');
        const soldList = document.getElementById('sold-list');
        const tabs = document.querySelectorAll('.tab-item');

        if (tabName === 'selling') {
          sellingList.classList.remove('hidden');
          soldList.classList.add('hidden');
          tabs[0].classList.add('active');
          tabs[1].classList.remove('active');
        } else {
          sellingList.classList.add('hidden');
          soldList.classList.remove('hidden');
          tabs[0].classList.remove('active');
          tabs[1].classList.add('active');
        }
      }
    </script>

    <script>
  // ì‹œê°„ í‘œì‹œ (app.jsì—ì„œ ì“°ë˜ ê±°ë‘ ë™ì¼)
  function formatTimeAgo(createdAt) {
    const t = new Date(createdAt);
    if (Number.isNaN(t.getTime())) return "";
    const diff = Math.floor((Date.now() - t.getTime()) / 1000);
    if (diff < 60) return "ë°©ê¸ˆ ì „";
    if (diff < 3600) return `${Math.floor(diff / 60)}ë¶„ ì „`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}ì‹œê°„ ì „`;
    return `${Math.floor(diff / 86400)}ì¼ ì „`;
  }

  function escapeHTML(str) {
    if (!str) return "";
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  function badgeClassByCategory(cat) {
    const c = (cat || "").trim();
    if (c === "ë‚˜ëˆ”") return "green";
    if (c === "ëŒ€ì—¬") return "blue";
    if (c === "êµí™˜") return "purple";
    return "green";
  }

  function priceTextByItem(it) {
    const cat = (it.category || "").trim();
    if (cat === "ëŒ€ì—¬") return `${Number(it.price || 0).toLocaleString()}ì›`;
    if (cat === "êµí™˜") return "êµí™˜ ğŸ”„";
    return "ë‚˜ëˆ” ğŸ";
  }

  function toHistoryCardHTML(it) {
    const imgSrc = it.imageUrl
      ? it.imageUrl
      : "https://placehold.co/476x476?text=No+Image";

    const cat = (it.category || "").trim();

    return `
      <div class="history-card">
        <div class="card-img-box">
          <img
            src="${imgSrc}"
            alt="ìƒí’ˆì´ë¯¸ì§€"
            style="width: 100%; height: 100%; object-fit: cover"
          />
          <button class="more-btn" data-item-id="${it.id}">â‹®</button>
        </div>
        <div class="card-info">
          <div class="status-row">
            <span class="status-badge ${badgeClassByCategory(cat)}">${escapeHTML(cat)}</span>
            <span class="time-text">${formatTimeAgo(it.createdAt)}</span>
          </div>
          <h3 class="card-title">${escapeHTML(it.title)}</h3>
          <p class="card-price">${priceTextByItem(it)}</p>
          <div class="card-footer">
            <span class="location">${escapeHTML(it.location || "")}</span>
            <div class="meta-counts">
              <span>ğŸ’¬ ${Number(it.chatCount || 0)}</span>
              <span>â¤ï¸ ${Number(it.likeCount || 0)}</span>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  async function loadMyHistory() {
    const sellingList = document.getElementById("selling-list");
    const soldList = document.getElementById("sold-list");

    const sellingCountEl = document.getElementById("sellingCount");
    const soldCountEl = document.getElementById("soldCount");

    // ë¡œê·¸ì¸ ìœ ì €
    const me =
      window.Auth?.getUser?.() ||
      window.Auth?.getSessionUser?.() ||
      null;
    const myUserId = me?.userId ?? null;

    if (!myUserId) {
      sellingList.innerHTML =
        '<p style="text-align:center;color:#888;padding:40px;">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>';
      soldList.innerHTML = "";
      sellingCountEl && (sellingCountEl.textContent = "0");
      soldCountEl && (soldCountEl.textContent = "0");
      return;
    }

    try {
      const res = await fetch("/api/items", { credentials: "include" });
      const items = await res.json();
      const list = Array.isArray(items) ? items : [];

      // âœ… ë‚´ê°€ ë“±ë¡í•œ ê¸€ë§Œ
      const mine = list.filter((it) => it.ownerUserId === myUserId);

      // âœ… ì¼ë‹¨ ì „ë¶€ íŒë§¤ì¤‘ì—ë§Œ ë„£ê¸° (ìš”êµ¬ì‚¬í•­)
      const selling = mine;
      const sold = []; // ë‚˜ì¤‘ì— ê±°ë˜ì™„ë£Œ í•„ë“œ ìƒê¸°ë©´ ë¶„ë¦¬

      sellingCountEl && (sellingCountEl.textContent = String(selling.length));
      soldCountEl && (soldCountEl.textContent = String(sold.length));

      if (selling.length === 0) {
        sellingList.innerHTML =
          '<p style="text-align:center;color:#888;padding:40px;">íŒë§¤/ëŒ€ì—¬ ì¤‘ì¸ ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      } else {
        sellingList.innerHTML = selling.map(toHistoryCardHTML).join("");
      }

      soldList.innerHTML =
        sold.length === 0
          ? '<p style="text-align:center;color:#888;padding:40px;">ê±°ë˜ì™„ë£Œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>'
          : sold.map(toHistoryCardHTML).join("");
    } catch (e) {
      console.error(e);
      sellingList.innerHTML =
        '<p style="text-align:center;color:red;padding:40px;">ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
    }
  }

  document.addEventListener("DOMContentLoaded", loadMyHistory);
</script>

    <div id="modal-root"></div>
    <script src="../Components/sidebar-auth.js"></script>
  </body>
</html>
