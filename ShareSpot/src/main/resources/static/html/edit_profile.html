<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‰ì–´ìŠ¤íŒŸ - í”„ë¡œí•„ ìˆ˜ì •</title>
  <link rel="stylesheet" href="../Css/style.css" />
  <link rel="stylesheet" href="../Css/edit_profile.css" />
</head>

<body>
  <div class="sidebar">
    <div class="brand">
      <img src="../Images/logo.png" alt="ë¡œê³ " class="brand-logo" />
      <div class="brand-text">
        <h1>ì‰ì–´ìŠ¤íŒŸ</h1>
        <p>ì‹œí¥ì‹œ ì •ì™•ë™</p>
      </div>
    </div>

    <div class="menu">
      <a href="main.html" class="menu-item"><span class="menu-icon">ğŸ </span> í™ˆ</a>
      <a href="near_me.html" class="menu-item"><span class="menu-icon">ğŸ“</span> ë‚´ ê·¼ì²˜</a>
      <a href="chat.html" class="menu-item"><span class="menu-icon">ğŸ’¬</span> ì±„íŒ…<span class="badge">3</span></a>
      <a href="my.html" class="menu-item active"><span class="menu-icon">ğŸ‘¤</span> ë‚˜ì˜ ì‹œí¥</a>
    </div>

    <div class="logout" id="logoutBtn"><span>ğŸšª</span> ë¡œê·¸ì•„ì›ƒ</div>
  </div>

  <div class="main-content edit-profile-layout">
    <div class="edit-header">
      <button class="cancel-btn" onclick="history.back()">ì·¨ì†Œ</button>
      <div class="header-title">í”„ë¡œí•„ ìˆ˜ì •</div>
      <button class="save-btn" onclick="saveProfile()">ì €ì¥</button>
    </div>

    <div class="edit-form-container">
      <div class="section-card profile-img-section">
        <div class="profile-img-wrapper">
          <div class="img-placeholder" id="avatarPlaceholder">?</div>
          <button class="camera-btn" type="button">ğŸ“·</button>
        </div>
        <div class="change-photo-text">í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½</div>
      </div>

      <div class="section-card">
        <div class="input-group">
          <label>ì´ë¦„</label>
          <input id="nicknameInput" type="text" value="" class="input-box" />
        </div>

        <div class="input-group">
          <label>ë‚´ ë™ë„¤</label>
          <div class="select-box">
            <select id="dongSelect" class="input-box">
              <option value="ì‹œí¥ì‹œ ì •ì™•ë™">ì‹œí¥ì‹œ ì •ì™•ë™</option>
              <option value="ì‹œí¥ì‹œ ë°°ê³§ë™">ì‹œí¥ì‹œ ë°°ê³§ë™</option>
              <option value="ì‹œí¥ì‹œ ì€í–‰ë™">ì‹œí¥ì‹œ ì€í–‰ë™</option>
              <option value="ì‹œí¥ì‹œ ëª©ê°ë™">ì‹œí¥ì‹œ ëª©ê°ë™</option>
            </select>
          </div>
        </div>

        <div class="input-group">
          <label>ì†Œê°œ</label>
          <textarea
            id="introTextarea"
            class="input-box textarea-box"
            placeholder="ìì‹ ì„ ì†Œê°œí•´ì£¼ì„¸ìš”"
          ></textarea>
        </div>
      </div>

      <div class="section-card">
        <div class="input-group">
          <label>ì „í™”ë²ˆí˜¸</label>
          <input
            id="phoneInput"
            type="text"
            value=""
            class="input-box"
            readonly
            style="background-color: #f3f4f6; color: #666"
          />
        </div>

        <div class="input-group">
          <label>ì´ë©”ì¼</label>
          <input
            id="emailInput"
            type="email"
            value=""
            class="input-box"
            readonly
            style="background-color: #f3f4f6; color: #666"
          />
        </div>
      </div>

      <div class="info-box">
        ğŸ“Œ ì „í™”ë²ˆí˜¸ì™€ ì´ë©”ì¼ì€ ë‹¤ë¥¸ ì‚¬ìš©ìì—ê²Œ ê³µê°œë˜ì§€ ì•Šìœ¼ë©°, ê±°ë˜ ì‹œ ì•ˆì „í•œ
        ì—°ë½ì„ ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <!-- âœ… DBì—ì„œ ë‚´ ì •ë³´ ë¡œë”© + ì €ì¥ -->
  <script>
    async function loadMeForEdit() {
      try {
        const res = await fetch("/api/user/me");
        if (!res.ok) {
          console.error("me api failed:", res.status);
          return;
        }
        const me = await res.json();

        // ê°’ ì±„ìš°ê¸°
        const nickname = me.nickname || me.userId || "";
        document.getElementById("nicknameInput").value = nickname;
        document.getElementById("dongSelect").value = me.dong || "ì‹œí¥ì‹œ ì •ì™•ë™";
        document.getElementById("introTextarea").value = me.intro || "";

        // ì½ê¸°ì „ìš©
        document.getElementById("phoneInput").value = me.phone || "";
        document.getElementById("emailInput").value = me.email || "";

        // ì•„ë°”íƒ€
        const initial =
          me.profileInitial ||
          (nickname && nickname.length > 0 ? nickname[0] : "?");
        document.getElementById("avatarPlaceholder").textContent = initial;
      } catch (e) {
        console.error(e);
      }
    }

    async function saveProfile() {
      try {
        const nickname = document.getElementById("nicknameInput").value.trim();
        const dong = document.getElementById("dongSelect").value;
        const intro = document.getElementById("introTextarea").value;

        if (!nickname) {
          alert("ì´ë¦„(ë‹‰ë„¤ì„)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        const res = await fetch("/api/user/me", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nickname, dong, intro })
        });

        if (!res.ok) {
          alert("í”„ë¡œí•„ ì €ì¥ ì‹¤íŒ¨");
          return;
        }

        // ì €ì¥ ì„±ê³µ â†’ ë§ˆì´í˜ì´ì§€
        location.href = "my.html";
      } catch (e) {
        console.error(e);
        alert("ì„œë²„ ì˜¤ë¥˜");
      }
    }

    loadMeForEdit();
  </script>
</body>
</html>
